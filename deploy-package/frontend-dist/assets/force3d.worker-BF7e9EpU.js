(function(){"use strict";const $={repulsion:-1600,springK:.03,restLength:56,gravity:.0018,damping:.9,timeStep:.016666666666666666,cellSize:110,frameHz:30};let S={...$},i=[],T=[],x=new Map,M=!1,A=0;function U(f=420){const e=Math.random(),s=Math.random(),t=2*Math.PI*e,r=Math.acos(2*s-1);return[f*Math.sin(r)*Math.cos(t),f*Math.sin(r)*Math.sin(t),f*Math.cos(r)]}function E(f){x.clear(),i=f.map((e,s)=>{const[t,r,z]=U(),y=Number.isFinite(e.x)?e.x:t,v=Number.isFinite(e.y)?e.y:r,n=Number.isFinite(e.z)?e.z:z;return x.set(e.id,s),{id:e.id,x:y,y:v,z:n,vx:0,vy:0,vz:0,deg:0}})}function K(f){T=[],i.forEach(e=>e.deg=0);for(const e of f){const s=x.get(e.source),t=x.get(e.target);s===void 0||t===void 0||s===t||(T.push({a:s,b:t,w:Math.max(.2,e.weight??1)}),i[s].deg++,i[t].deg++)}}const q=(f,e,s,t)=>`${Math.floor(f/t)},${Math.floor(e/t)},${Math.floor(s/t)}`;function D(){const{repulsion:f,springK:e,restLength:s,gravity:t,damping:r,timeStep:z,cellSize:y}=S,v=new Map;for(let n=0;n<i.length;n++){const o=i[n],c=q(o.x,o.y,o.z,y);let a=v.get(c);a||v.set(c,a=[]),a.push(n)}for(let n=0;n<i.length;n++){const o=i[n];let c=0,a=0,l=0;const p=Math.floor(o.x/y),g=Math.floor(o.y/y),w=Math.floor(o.z/y);for(let d=-1;d<=1;d++)for(let u=-1;u<=1;u++)for(let h=-1;h<=1;h++){const m=v.get(`${p+d},${g+u},${w+h}`);if(m)for(const H of m){if(H===n)continue;const F=i[H];let b=o.x-F.x,k=o.y-F.y,N=o.z-F.z;const L=b*b+k*k+N*N+.001,I=1/Math.sqrt(L),P=f/L;b*=I,k*=I,N*=I,c+=b*P,a+=k*P,l+=N*P}}c+=-o.x*t,a+=-o.y*t,l+=-o.z*t,o.fixed||(o.vx=(o.vx+c*z)*r,o.vy=(o.vy+a*z)*r,o.vz=(o.vz+l*z)*r)}for(const n of T){const o=i[n.a],c=i[n.b],a=c.x-o.x,l=c.y-o.y,p=c.z-o.z,g=Math.sqrt(a*a+l*l+p*p)+1e-6,w=g-s,d=e*w*n.w,u=a/g,h=l/g,m=p/g;o.fixed||(o.vx+=u*d*.5,o.vy+=h*d*.5,o.vz+=m*d*.5),c.fixed||(c.vx-=u*d*.5,c.vy-=h*.5*d,c.vz-=m*.5*d)}for(const n of i){if(n.fixed){n.fx!==void 0&&(n.x=n.fx,n.y=n.fy,n.z=n.fz);continue}n.x+=n.vx,n.y+=n.vy,n.z+=n.vz}}function O(f){const e=1e3/S.frameHz;if(f-A<e)return;A=f;const s=new Float32Array(i.length*3);for(let t=0;t<i.length;t++){const r=i[t];s[t*3+0]=r.x,s[t*3+1]=r.y,s[t*3+2]=r.z}postMessage({type:"TICK",positions:s,ids:i.map(t=>t.id)},[s.buffer])}function j(){M&&(D(),O(performance.now()),setTimeout(j,0))}self.onmessage=f=>{const e=f.data;switch(e.type){case"INIT":S={...$,...e.params||{}},E(e.nodes),K(e.edges);break;case"UPDATE_GRAPH":E(e.nodes),K(e.edges);break;case"START":M||(M=!0,j());break;case"STOP":M=!1;break;case"PIN":{const s=x.get(e.id);if(s!==void 0){const t=i[s];t.fixed=!0,e.fixed&&(t.fx=e.fixed[0],t.fy=e.fixed[1],t.fz=e.fixed[2])}break}case"UNPIN":{const s=x.get(e.id);if(s!==void 0){const t=i[s];t.fixed=!1,t.fx=t.fy=t.fz=void 0}break}}}})();
