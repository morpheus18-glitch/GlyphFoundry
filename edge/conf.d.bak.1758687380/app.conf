map $http_upgrade $connection_upgrade { default upgrade; '' close; }
limit_req_zone $binary_remote_addr zone=req_zone:10m rate=100r/s;

upstream backend_upstream { server gf_backend:8000; keepalive 64; }
upstream frontend_upstream { server gf_frontend:80;  keepalive 64; }

server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name fitwellfast.com www.fitwellfast.com;

  add_header X-Frame-Options DENY always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; worker-src 'self' blob:; child-src 'self' blob:; object-src 'none'; frame-ancestors 'none'" always;

  location /.well-known/acme-challenge/ { root /var/www/certbot; try_files $uri =404; }

  location /healthz {
    proxy_pass http://backend_upstream/healthz;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Backend API (keep it simple: only what we need)
  location ~ ^/(graph3d|tags|busz|produce)/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_read_timeout 65s;
    proxy_send_timeout 65s;
    proxy_connect_timeout 5s;
    proxy_pass http://backend_upstream;
  }

  # Harden a bit
  include /etc/nginx/conf.d/block-probes.inc;

  # Frontend
  location / {
    limit_req zone=req_zone burst=200 nodelay;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_read_timeout 65s;
    proxy_send_timeout 65s;
    proxy_connect_timeout 5s;
    proxy_pass http://frontend_upstream;
  }
}
