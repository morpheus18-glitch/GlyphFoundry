# Upstreams
upstream backend_upstream { server gf_backend:8000; keepalive 64; }
upstream frontend_upstream { server gf_frontend:80;  keepalive 64; }

# HTTP server - redirects to HTTPS
server {
  listen 80;
  listen [::]:80;
  server_name fitwellfast.com www.fitwellfast.com;

  location /.well-known/acme-challenge/ { 
    root /var/www/certbot; 
    try_files $uri =404; 
  }
  
  location / { 
    return 301 https://$host$request_uri; 
  }
}

# HTTPS server - main application
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name fitwellfast.com www.fitwellfast.com;

  include /etc/nginx/conf.d/security.conf;
  include /etc/nginx/conf.d/block-probes.inc;

  ssl_certificate     /etc/letsencrypt/live/fitwellfast.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/fitwellfast.com/privkey.pem;

  # Health check
  location /healthz {
    proxy_pass http://backend_upstream/healthz; 
  }

  # Backend API
  location ~ ^/(busz|tags|graph3d|produce|pipeline|graph|messages)(/.*)?$ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_read_timeout 65s;
    proxy_send_timeout 65s;
    proxy_connect_timeout 5s;
    proxy_pass http://backend_upstream;
  }

  # Frontend (everything else)
  location / {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_read_timeout 65s;
    proxy_send_timeout 65s;
    proxy_connect_timeout 5s;
    proxy_pass http://frontend_upstream;
  }
}
